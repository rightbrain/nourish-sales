<?php

namespace Rbs\Bundle\SalesBundle\Repository;

use Doctrine\ORM\EntityRepository;
use Rbs\Bundle\SalesBundle\Entity\Order;
use Rbs\Bundle\SalesBundle\Entity\OrderItem;

/**
 * OrderItemRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class OrderItemRepository extends EntityRepository
{
    public function getAll()
    {
        return $this->findAll();
    }

    public function create($data)
    {
        $this->_em->persist($data);
        $this->_em->flush();
    }

    public function delete($data)
    {
        $this->_em->remove($data);
        $this->_em->flush();
    }

    public function update($data)
    {
        $this->_em->persist($data);
        $this->_em->flush();
        return $this->_em;
    }

    public function orderAmountAdjust(Order $order)
    {
        $amount = $order->getPaidAmount();

        foreach($order->getOrderItems() as $orderItem){
            $dueAmount = $orderItem->getDueAmount();

            if($amount != 0 and $dueAmount != 0){
                if ($amount >= $dueAmount) {
                    $amount = $amount - $dueAmount;
                    $orderItem->setPaidAmount($dueAmount);
                } else{
                    $orderItem->setPaidAmount($amount);
                    $amount = 0;
                }
            }else{
                $orderItem->setPaidAmount(0);
            }
            $this->update($orderItem);
        }
    }

    public function getTotalOrderItemByOrder(Order $order)
    {
        $query = $this->createQueryBuilder('o');
        $query
            ->select('SUM(o.quantity) AS totalQuantity')
            ->where('o.order = :order')
            ->setParameter('order', $order);

        return $query->getQuery()->getSingleScalarResult();
    }

    public function orderItemReport($data)
    {
        $query = $this->createQueryBuilder('oi');
        $query->join('oi.order', 'o');
        $query->join('oi.item', 'i');
        $query->select('i.name as itemName');
        $query->addSelect('i.id as id');
        $query->addSelect('SUM(oi.quantity) as quantity');
        $query->addSelect('SUM(oi.totalAmount) as totalAmount');

        $this->handleSearchByItem($data, $query);
        $this->handleSearchByTwoDate($data, $query);

        $query->andWhere('o.orderState = :COMPLETE');
        $query->setParameter('COMPLETE', Order::ORDER_STATE_COMPLETE);

        $query->groupBy('i.id');
        $query->orderBy('i.name');

        $result = $query->getQuery()->getResult();

        $data = array();
        foreach($result as $row) {
            $data[$row['id']] = $row;
        }

        return $data;
    }

    protected function handleSearchByItem($data, $query)
    {
        if (!empty($data['search']['item'])) {
            $query->where('i.id = :item');
            $query->setParameter('item', $data['search']['item']);
        }
    }

    protected function handleSearchByTwoDate($data, $query)
    {
        if (!empty($data['start_date']) && !empty($data['end_date'])) {
            $query->andWhere('o.createdAt >= :start_date');
            $query->andWhere('o.createdAt <= :end_date');
            $query->setParameter('start_date', $data['start_date'].' 00:00:01');
            $query->setParameter('end_date', $data['end_date'].' 23:59:59');
        }
    }

    public function getAmountDiff($agentId, $startDate, $endDate)
    {
        $query = $this->createQueryBuilder('oi');
        $query->join('oi.order', 'o');
        $query->join('o.agent', 'a');
        $query->join('a.user', 'u');
        $query->join('oi.item', 'i');
        $query->join('i.category', 'ca');

        $query->select('ca.name as categoryName');
        $query->addSelect('ca.id as categoryId');
        $query->addSelect('u.username as agentName');
        $query->addSelect('a.id as agentId');
        $query->addSelect('SUM(oi.paidAmount) as paidAmount');
        $query->addSelect('SUM(oi.totalAmount) as totalAmount');

        $query->where('o.agent = :agentId');
        $query->andWhere('o.orderState = :COMPLETE');

        $query->andWhere('o.createdAt >= :startDate');
        $query->andWhere('o.createdAt <= :endDate');

        $query->setParameters(array('COMPLETE' => Order::ORDER_STATE_COMPLETE, 'agentId' => $agentId, 'startDate' => $startDate, 'endDate' => $endDate));
        $query->groupBy('ca.id');

        return $query->getQuery()->getScalarResult();
    }

    public function getCreditStatus(OrderItem $orderItem)
    {
        $creditInfo = $this->_em->getRepository('RbsSalesBundle:CreditLimit')->getCreditLimitByDate($orderItem);

        if (!$creditInfo) {
            return array(
                'totalAmount' => 0,
                'paidAmount' => 0,
                'creditRemain' => 0
            );
        }
        
        $qb = $this->createQueryBuilder('oi');

        $qb->select('SUM(oi.totalAmount) AS totalAmount');
        $qb->addSelect('SUM(oi.paidAmount) AS paidAmount');
        $qb->addSelect($creditInfo->getAmount() . ' - SUM(oi.totalAmount) + SUM(oi.paidAmount) AS creditRemain');

        $qb->join('oi.item', 'i');
        $qb->join('i.category', 'c');
        $qb->join('oi.order', 'o');

        $qb->where('o.agent = :agent')->setParameter('agent', $orderItem->getOrder()->getAgent());
        $qb->andWhere('o.createdAt >= :startDate')->setParameter('startDate', $creditInfo->getStartDate());
        $qb->andWhere('o.createdAt <= :eneDate')->setParameter('eneDate', $creditInfo->getEndDate());
        $qb->andWhere($qb->expr()->eq('c.id', ':categoryId'))->setParameter('categoryId', $creditInfo->getCategory()->getId());
        $qb->groupBy('c.id');
        
        return $qb->getQuery()->getResult();
    }

    public function getOrderIncentive($orderId)
    {
        $query = $this->createQueryBuilder('oi');
        $query->join('oi.order', 'o');
        $query->join('o.agent', 'a');
        $query->join('oi.item', 'i');
        $query->join('i.category', 'c');
        $query->select('SUM(oi.quantity) as quantity');
        $query->addSelect('a.id as agentId');
        $query->addSelect('c.id as categoryId');
        $query->addSelect('c.name as categoryName');
        $query->where('o.id = :orderId');
        $query->groupBy('c.id');
        $query->setParameters(array('orderId'=>$orderId));

        return $query->getQuery()->getResult();
    }
}
